### Use case

For connecting to a VPN using Cisco's Anyconnect application, we require username, password and a TOTP (Time based OTP). The normal flow for a user trying to connect to VPN is like this:

1. Open the Cisco AnyConnect VPN GUI Application
2. Enter the username and password (username is generally prefilled)
3. Enter the second password (TOTP) which needs to be looked from either your mobile phone or some other TOTP generating application

Now, enterprise VPNs are notorious for blocking even some of the essential websites. Add to that, the download speed degradation and the higher latencies result into a much worse (but secure) browsing experience. It's quite cumbersome for someone having to connect and disconnect VPN multiple times each day. Hence, this script automates that connection process.

### Dependencies

1. Bitwarden CLI Application (`bw`) -- A free cross platform password manager (https://bitwarden.com/help/article/cli/#download-and-install)
2. CiscoAnyconnect CLI Application -- If you have the GUI Application, the CLI application binary is generally present in `/opt/cisco/anyconnect/bin`
3. `expect` -- Can be installed using `brew install expect` (manpage: https://linux.die.net/man/1/expect)
4. `oathtool` -- Can be installed using `brew install oath-toolkit` (reference: https://www.nongnu.org/oath-toolkit/)
5. `openssl` -- Preinstalled on most of the \*nix systems

### Installation

Please install the above tools using homebrew firstly, and make sure to setup `PATH` env variable properl y so that the binaries are accessible.

Next thing we need to do is to save the Walmart SSO Password and the TOTP Key in BW Vault as "Login" type. 

I have the following saved as secure notes in BW vault, where the "Name" field maps to the "Password":

* walmart-sso-password -> *MyWalmartSSOPassword*
* walmart-totp-key -> *MyWalmartTOTPKey*

The first one "walmart-sso-password" is straight forward -- it's your Walmart Password you use to login to SSO.
The second one is the TOTP Key that's generated when we enroll a new device/app on `wmlink/linotp`. You can install a chrome extension `Authenticator` (https://chrome.google.com/webstore/detail/authenticator/bhghoamapcdpbohphigoooaddinpkbai), use that to scan the QR code, export a backup from `Autheticator` extension, and there you'll find your TOTP secret key. Once you have the secret key, you can store that in BW vault.

Once you're done storing the above two credentials, you can run the `login.sh` script and it'll connect you to "WeC Two Factor VPN".

### Trust Model

Entities assumed to be trusted:
1. Bitwarden Vault
2. Root user on your local system (i.e. their public-private key pair)

Let's abbreviate Bitwarden as BW from now. Also, if you use iterm2 on Macos, please use TouchID to authenticate sudo access (See here: https://dev.to/equiman/how-to-use-macos-s-touch-id-on-terminal-5fhg).

Basically, the idea is to store your Walmart account's password and the 2 factor authentication key inside BW vault (assumed to be trusted). Each time we have to unlock the BW vault, the BW CLI application asks for password and creates a session and returns a session key.

Any subsequent query that we need to make to fetch items from our BW vault must be accompanied with the session key that we previously got. The problem now is to store the Bitwarden Master Password somewhere (obviously encrypted) so that we can automate this whole process of getting a session key. The idea is to lay our trust on the root user of the system, and use the RSA public key generated by the root user to encrypt our BW Master Password. This way, only those users who themselves have sudo access (or anyone who has access to the root user's private key) will be able to decrypt the encrypted BW Master Password.

Now, I know this has its flaws that how come I'm trusting the root user, that if lets say any other normal user has (ALL) sudo privileges, they can possibly use the root user's private key to decrypt my BW Master Password -- Please refer this: https://unix.stackexchange.com/questions/159614/what-mechanism-prevents-any-user-from-accessing-any-other-users-files-via-root?noredirect=1&lq=1.

The reason we have to do so much (the whole RSA public-private key thingy) is because Bitwarden CLI application doesn't support directly unlocking the vault using TouchID (the Desktop GUI application does). Moreover, the Apple Keychain has its own limitations so we can't store our credentials (walmart password and TOTP key) there. So, we have to do it like this. This has issues, but it works, and if you have a malicious user having sudo/root access, you have much bigger problems to worry about than saving your Bitwarden password.

Hope it helps. :-)
